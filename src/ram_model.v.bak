`timescale 1ns / 1ps

module ram_model #(
    parameter DATA_WIDTH = 32,
    parameter ADDR_WIDTH = 20,
    parameter MEM_FILE   = "program.mem"
)(
    input  wire                     clk,
    input  wire                     resetn,     // ACTIVE-LOW RESET
    input  wire                     mem_valid,
    input  wire [3:0]               mem_wstrb,
    input  wire [ADDR_WIDTH+1:0]    mem_addr,   // BYTE ADDRESS
    input  wire [DATA_WIDTH-1:0]    mem_wdata,

    output reg  [DATA_WIDTH-1:0]    mem_rdata,
    output reg                      mem_ready
);

    localparam MEM_BYTES = (1 << (ADDR_WIDTH + 2));

    reg [7:0] memory_bytes [0:MEM_BYTES-1];
    integer i;

    initial begin
        for (i = 0; i < MEM_BYTES; i = i + 1)
            memory_bytes[i] = 8'h00;

        if (MEM_FILE != "") begin
            $display("Loading memory image from %s", MEM_FILE);
            $readmemh(MEM_FILE, memory_bytes);
        end
    end

    // Combinational read (PicoRV32 expects zero-latency)
    always @(*) begin
        mem_ready = mem_valid;

        if (mem_valid && mem_wstrb == 4'b0000 && mem_addr + 3 < MEM_BYTES) begin
            mem_rdata = {
                memory_bytes[mem_addr + 3],
                memory_bytes[mem_addr + 2],
                memory_bytes[mem_addr + 1],
                memory_bytes[mem_addr + 0]
            };
        end else begin
            mem_rdata = 32'h00000000;
        end
    end

    // Synchronous writes
    always @(posedge clk) begin
        if (!resetn) begin
            mem_ready <= 1'b0;
        end else if (mem_valid && |mem_wstrb && mem_addr < MEM_BYTES) begin
            if (mem_wstrb[0]) memory_bytes[mem_addr + 0] <= mem_wdata[7:0];
            if (mem_wstrb[1] && mem_addr+1 < MEM_BYTES) memory_bytes[mem_addr + 1] <= mem_wdata[15:8];
            if (mem_wstrb[2] && mem_addr+2 < MEM_BYTES) memory_bytes[mem_addr + 2] <= mem_wdata[23:16];
            if (mem_wstrb[3] && mem_addr+3 < MEM_BYTES) memory_bytes[mem_addr + 3] <= mem_wdata[31:24];
        end
    end

endmodule
